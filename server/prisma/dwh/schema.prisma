datasource db {
    provider = "postgresql"
    url      = env("DWH_DATABASE_URL")
}

generator client {
    provider = "prisma-client-js"
    output   = "../generated/client/dwh"
}

model BusinessDimension {
    business_id       Int                   @id @default(autoincrement())
    business_name     String
    product_revenues  ProductRevenueFact[]
    category_revenues CategoryRevenueFact[]
    product_prices    BatchPrice[]
}

model CategoryDimension {
    category_id       Int                   @id @default(autoincrement())
    category_name     String
    has_expiry_date   Boolean               @default(false)
    products          ProductDimension[]
    category_revenues CategoryRevenueFact[]
}

model ProductDimension {
    product_id          Int                  @id @default(autoincrement())
    name                String
    category_id         Int
    next_expiry_date_id Int?
    next_expiry_date    DateDimension?       @relation(fields: [next_expiry_date_id], references: [date_id])
    CategoryDimension   CategoryDimension    @relation(fields: [category_id], references: [category_id])
    product_revenues    ProductRevenueFact[]
    prices              BatchPrice[]
}

model ProductRevenueFact {
    product_id       Int
    business_id      Int
    date_id          Int
    revenue_amount   Float
    total_units_sold Int

    date     DateDimension     @relation(fields: [date_id], references: [date_id])
    business BusinessDimension @relation(fields: [business_id], references: [business_id])
    product  ProductDimension  @relation(fields: [product_id], references: [product_id])

    @@id([product_id, business_id])
}

model CategoryRevenueFact {
    business_id      Int
    category_id      Int
    date_id          Int
    revenue_amount   Float
    total_units_sold Int

    date     DateDimension     @relation(fields: [date_id], references: [date_id])
    business BusinessDimension @relation(fields: [business_id], references: [business_id])
    category CategoryDimension @relation(fields: [category_id], references: [category_id])

    @@id([business_id, category_id])
}

model BatchPrice {
    product_id     Int
    business_id    Int
    date_id        Int
    purchase_price Float

    date     DateDimension     @relation(fields: [date_id], references: [date_id])
    business BusinessDimension @relation(fields: [business_id], references: [business_id])
    product  ProductDimension  @relation(fields: [product_id], references: [product_id])

    @@id([product_id, business_id])
}

model DateDimension {
    date_id   Int      @id @default(autoincrement())
    full_date DateTime
    day       Int
    week      Int
    month     Int
    quarter   Int
    year      Int

    product_revenues  ProductRevenueFact[]
    category_revenues CategoryRevenueFact[]
    batch_prices      BatchPrice[]
    expiring_products ProductDimension[]
}
